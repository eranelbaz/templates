version: 2
deploy:
  environmentVariables:
    - name: ENV0_POLICY_DATA_PATH
      value: /tmp/changes.json  # Dynamically set the policy data path

  steps:
    terraformInit:
      after:
        - name: Check lock file changes
          run: |
            if [ -f .terraform/.terraform.lock.hcl_bk ]; then
              # If backup exists, check for changes and update backup
              if [ -f .terraform.lock.hcl ]; then
                diff_output=$(diff .terraform.lock.hcl .terraform/.terraform.lock.hcl_bk)
                if [ $? -ne 0 ]; then
                  echo "Lock file has changed:"
                  echo "$diff_output"
                  echo '{"changed": true}' > $ENV0_POLICY_DATA_PATH  # Record changes in policy data
                else
                  echo "No changes in the lock file."
                  echo '{"changed": false}' > $ENV0_POLICY_DATA_PATH  # Record no changes
                fi               
              else
                echo "No .terraform.lock.hcl file to compare."
                echo '{"changed": false}' > $ENV0_POLICY_DATA_PATH
              fi
            fi
            cp .terraform.lock.hcl .terraform/.terraform.lock.hcl_bk
